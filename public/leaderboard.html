<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ГРЕЧЕМОЛКА 3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            background-image: url("/public/bg1.jpg");
            background-attachment: fixed;
            background-position: center;
        }
        h1 {
            text-align: center;
            color: ivory;
            text-shadow: 4px 4px 5px #9541AC;
        }
        h4.subtitle {
            text-align: center;
            margin: -20px auto 20px;
            color: ivory;
            text-shadow: 0px 0px 7px #000;
            font-family: "Space Mono", monospace;
            font-weight: 700;
            font-style: normal;
            font-size: 19px;
        }
        .copy-address {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .copy-address:after {
            content: '';
            display: inline-flex;
            align-items: center;
            position: relative;
            top: 1px;
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml,<!--%3Fxml version="1.0" encoding="UTF-8"%3F--><!-- The Best Svg Icon site in the world: iconSvg.co, Visit us! https://iconsvg.co --><svg id="svg" fill="%23ffffff" stroke="%23ffffff" width="200" height="200" version="1.1" viewBox="144 144 512 512" xmlns="http://www.w3.org/2000/svg"><g id="IconSvg_bgCarrier" stroke-width="0"></g><g id="IconSvg_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="%23CCCCCC" stroke-width="0"><path xmlns="http://www.w3.org/2000/svg" d="m578.43 211.07h-293.89c-6.2969 0-10.496 4.1992-10.496 10.496v41.984h-52.48c-6.2969 0-10.496 4.1992-10.496 10.496v304.39c0 6.2969 4.1992 10.496 10.496 10.496h295.99c6.2969 0 10.496-4.1992 10.496-10.496v-45.133l50.379-0.003906c6.2969 0 10.496-4.1992 10.496-10.496v-301.23c0-6.2969-4.1953-10.496-10.496-10.496zm-71.371 356.86h-275v-283.39h51.43 1.0508 222.52zm60.875-55.629h-39.887l0.003906-238.26c0-6.2969-4.1992-10.496-10.496-10.496h-222.52v-31.488h272.9z"></path></g><g id="IconSvg_iconCarrier"><path xmlns="http://www.w3.org/2000/svg" d="m578.43 211.07h-293.89c-6.2969 0-10.496 4.1992-10.496 10.496v41.984h-52.48c-6.2969 0-10.496 4.1992-10.496 10.496v304.39c0 6.2969 4.1992 10.496 10.496 10.496h295.99c6.2969 0 10.496-4.1992 10.496-10.496v-45.133l50.379-0.003906c6.2969 0 10.496-4.1992 10.496-10.496v-301.23c0-6.2969-4.1953-10.496-10.496-10.496zm-71.371 356.86h-275v-283.39h51.43 1.0508 222.52zm60.875-55.629h-39.887l0.003906-238.26c0-6.2969-4.1992-10.496-10.496-10.496h-222.52v-31.488h272.9z"></path></g></svg>');
            background-size: cover;
        }

        #custom-alert {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 1.5rem;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #custom-alert-text {
            background: #333;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
            margin: auto 30px;
            text-align: center;
        }

        #downloadCsv {
            display: block;
            margin: 20px auto;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        #leaderboard {
            display: flex;
            flex-direction: column;
            margin: 0 5px;
            background: rgb(120 103 197 / 80%);
        }

        .leaderboard-header, .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 7px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.3);
        }
        .leaderboard-header {
            position: sticky;
            top:0;
            background: #bb37fc;
            font-weight:700;
            font-size: 18px;
        }

        .col-1 {
            width:10%;
        }
        .col-2 {
            width:70%;
            text-align: left;
            font-family: monospace;
        }
        .col-3 {
            width:20%;
            text-align:right;
        }

        .leaderboard-item .col-1, .leaderboard-item .col-3 {
            font-size: 17px;
        }
        .leaderboard-item .col-2 {
            font-weight: 700;
            font-size: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .error {
            color: ivory;
            text-align: center;
            padding:10px;
        }

        section.day-select {
            display: flex;
            align-items: center;
            margin: 0 5px 5px;
            justify-content: space-between;
        }
        section.day-select button {
            display: flex;
            align-items: center;
            background: #bb37fc;
            color: ivory;
            text-shadow: 4px 4px 5px #9541AC;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            max-height: 35px;
        }
        section.day-select button#dayD {
            border-color: whitesmoke;
        }

        section.day-select button.active-day {
            background-color: #6a27c8;
            box-shadow: 0 0 8px 2px #bb37fc;
        }

        @media (max-width: 480px) {
            section.day-select button {
                padding: 3px;
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
<h1>ГРЕЧЕМОЛКА 3 - leaderboard</h1>
<h4 class="subtitle"><div class="copy-address">grecha_duplo.near</div></h4>

<!-- Custom Alert Container -->
<div id="custom-alert">
    <div id="custom-alert-text"></div>
</div>

<section class="day-select">
    <button id="day1">Day 1</button>
    <button id="day2">Day 2</button>
    <button id="day3">Day 3</button>
    <button id="day4">Day 4</button>
    <button id="day5">Day 5</button>
    <button id="day6">Day 6</button>
    <button id="day7">Day 7</button>
    <button id="dayD">Reset</button>
</section>

<div id="leaderboard">
    <div class="leaderboard-header">
        <div class="col-1">№</div>
        <div class="col-2">Кошелек</div>
        <div class="col-3">Сумма</div>
    </div>
    <div id="items"></div>

    <button id="downloadCsv">Скачать CSV</button>
</div>

<script>
    const API_PATH = '/api/grecha';
    const WALLET_ID = 'grecha_duplo.near';
    const COINS    = [
        { symbol: 'YUM', coeff: 0.0000005 },
        { symbol: 'GRECHA', coeff: 0.001 },
    ];
    let SINCE_DATETIME = '2025-08-22T11:00';
    let UNTIL_DATETIME = '2025-08-28T22:00';
    let SINCE_MS     = new Date(SINCE_DATETIME).getTime();
    let UNTIL_MS     = new Date(UNTIL_DATETIME).getTime();
    const BATCH = 200;
    const MIN_INTERVAL = 1 * 60 * 1000;  // 1 minute

    let lastFetchTime = 0;
    let lastSorted = [];

    let isLoading = false;

    // Takes all the translation stacks by symbol.
    async function fetchAllFor(symbol) {
        const all = [];
        for (let skip = 0; ; skip += BATCH) {
            const url = `${API_PATH}`
                + `?wallet_id=${encodeURIComponent(WALLET_ID)}`
                + `&symbol=${encodeURIComponent(symbol)}`
                + `&direction=in`
                + `&limit=${BATCH}`
                + `&skip=${skip}`;
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`API ${resp.status}`);
            const { transfers } = await resp.json();
            if (!Array.isArray(transfers) || transfers.length === 0) break;
            all.push(...transfers);
            if (transfers.length < BATCH) break;
        }
        return all;
    }

    // Collects, filters, groups and returns a sorted array {wallet, total}
    async function fetchData() {
        if (isLoading) {
            // If the download is already in progress, do not start again
            return lastSorted;
        }

        isLoading = true;
        disableButtons(true);

        const now = Date.now();
        if (now - lastFetchTime < MIN_INTERVAL) {
            isLoading = false;
            disableButtons(false);

            // If it is too frequent, we immediately revert to the past data
            return lastSorted;
        }
        lastFetchTime = now;

        try {
            const globalSums = {};
            for (const { symbol, coeff } of COINS) {
                const data = await fetchAllFor(symbol);
                data
                    .filter(tx => {
                        const txMs = Number(tx.timestamp_nanosec) / 1e6;
                        return txMs >= SINCE_MS && txMs <= UNTIL_MS;
                    })
                    .forEach(tx => {
                        const val = parseFloat(tx.amount) * coeff;
                        globalSums[tx.from] = (globalSums[tx.from] || 0) + val;
                    });
            }

            const sorted = Object.entries(globalSums)
                .map(([wallet, total]) => ({ wallet, total }))
                .sort((a, b) => b.total - a.total);

            lastSorted = sorted;
            return sorted;
        } finally {
            isLoading = false;
            disableButtons(false);
        }
    }

    // Renders the results
    async function renderBoard() {
        const container = document.getElementById('items');
        container.innerHTML = '';
        try {
            const sorted = await fetchData();
            if (!sorted.length) {
                container.innerHTML = `<div class="error">
            Нет переводов в период<br>
            ${SINCE_DATETIME.replace('T',' ')} — ${UNTIL_DATETIME.replace('T',' ')}
          </div>`;
                return;
            }
            sorted.forEach((item, i) => {
                const row = document.createElement('div');
                row.className = 'leaderboard-item';
                row.innerHTML = `
            <div class="col-1">${i+1}</div>
            <div class="col-2">${item.wallet}</div>
            <div class="col-3">
              ${item.total.toLocaleString(undefined,{
                    minimumFractionDigits:3,
                    maximumFractionDigits:3
                })}
            </div>`;
                container.appendChild(row);
            });
        } catch (err) {
            container.innerHTML = `<div class="error">Ошибка: ${err.message}</div>`;
            console.error(err);
        }
    }

    // Function to lock/unlock day buttons
    function disableButtons(disable) {
        const buttons = document.querySelectorAll('section.day-select button');
        buttons.forEach(btn => btn.disabled = disable);
    }

    // Button handlers with isLoading flag check
    function onDayButtonClick(since, until, e) {
        if (isLoading) return;  // ignore clicks if the download
        setDateRange(since, until);
        setActiveButton(e.currentTarget);
    }

    // Generates a CSV and initiates its download
    async function downloadCsv() {
        try {
            const sorted = lastSorted.length ? lastSorted : await fetchData();
            let csv = '#,Wallet,Points\n';
            csv += sorted
                .map((item, idx) =>
                    `${idx+1},${item.wallet},${item.total.toFixed(3)}`
                )
                .join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'leaderboard.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) {
            alert('Ошибка при создании CSV: ' + err.message);
            console.error(err);
        }
    }

    // Function for updating dates and redrawing the table
    function setDateRange(since, until) {
        SINCE_DATETIME = since;
        UNTIL_DATETIME = until;
        SINCE_MS = new Date(SINCE_DATETIME).getTime();
        UNTIL_MS = new Date(UNTIL_DATETIME).getTime();
        // Reset the cache to force a new request
        lastFetchTime = 0;
        renderBoard();
    }

    function setActiveButton(activeBtn) {
        const buttons = document.querySelectorAll('section.day-select button');
        buttons.forEach(btn => btn.classList.remove('active-day'));
        activeBtn.classList.add('active-day');
    }

    // Add handlers for buttons
    document.getElementById('day1').addEventListener('click', (e) => {
        setDateRange('2025-08-22T11:00', '2025-08-22T23:59');
        setActiveButton(e.currentTarget);
    });
    document.getElementById('day2').addEventListener('click', (e) => {
        setDateRange('2025-08-23T00:00', '2025-08-23T23:59');
        setActiveButton(e.currentTarget);
    });
    document.getElementById('day3').addEventListener('click', (e) => {
        setDateRange('2025-08-24T00:00', '2025-08-24T23:59');
        setActiveButton(e.currentTarget);
    });
    document.getElementById('day4').addEventListener('click', (e) => {
        setDateRange('2025-08-25T00:00', '2025-08-25T23:59');
        setActiveButton(e.currentTarget);
    });
    document.getElementById('day5').addEventListener('click', (e) => {
        setDateRange('2025-08-26T00:00', '2025-08-26T23:59');
        setActiveButton(e.currentTarget);
    });
    document.getElementById('day6').addEventListener('click', (e) => {
        setDateRange('2025-08-27T00:00', '2025-08-27T23:59');
        setActiveButton(e.currentTarget);
    });
    document.getElementById('day7').addEventListener('click', (e) => {
        setDateRange('2025-08-28T00:00', '2025-08-28T22:00');
        setActiveButton(e.currentTarget);
    });
    document.getElementById('dayD').addEventListener('click', (e) => {
        setDateRange('2025-08-22T11:00', '2025-08-28T22:00');
        setActiveButton(e.currentTarget);
    });

    document
        .getElementById('downloadCsv')
        .addEventListener('click', downloadCsv);

    window.addEventListener('DOMContentLoaded', renderBoard);

    // Find the element
    const copyAddress = document.querySelector('.copy-address');
    const alertOverlay = document.getElementById('custom-alert');
    const alertText = document.getElementById('custom-alert-text');
    let alertTimeout;

    copyAddress.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(copyAddress.textContent.trim());
            showCustomAlert('Адрес скопирован в буфер обмена!');
        } catch (err) {
            fallbackCopyTextToClipboard(copyAddress.textContent.trim());
        }
    });

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) showCustomAlert('Адрес скопирован в буфер обмена!');
            else showCustomAlert('Не удалось скопировать адрес');
        } catch (err) {
            showCustomAlert('Не удалось скопировать адрес');
        }

        document.body.removeChild(textArea);
    }

    function showCustomAlert(message) {
        clearTimeout(alertTimeout);
        alertText.textContent = message;
        alertOverlay.style.display = 'flex';
        // Запускаем анимацию появления
        requestAnimationFrame(() => {
            alertOverlay.style.opacity = '1';
        });
        // Через 1 секунду скрываем
        alertTimeout = setTimeout(() => {
            alertOverlay.style.opacity = '0';
            alertOverlay.addEventListener('transitionend', () => {
                alertOverlay.style.display = 'none';
            }, { once: true });
        }, 1000);
    }
</script>
</body>
</html>