<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>NFT Reputation Leaderboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; padding: 1rem; }
        .controls { display: flex; flex-wrap: wrap; gap: .5rem; align-items: center; margin-bottom: 1rem; }
        .controls label { white-space: nowrap; }
        .controls input[type="text"] { width: 150px; }
        .controls input[type="datetime-local"] { width: 200px; }
        #leaderboard { max-width: 600px; }
        .leaderboard-header, .leaderboard-item {
            display: grid; grid-template-columns: 1fr 3fr 2fr;
            padding: .5rem 0; border-bottom: 1px solid #ddd;
        }
        .leaderboard-header { font-weight: bold; border-bottom: 2px solid #aaa; }
        .error { color: red; padding: 1rem 0; }
    </style>
</head>
<body>
<h1>NFT Reputation Leaderboard</h1>

<div class="controls">
    <label for="wallet">Wallet ID:</label>
    <input type="text" id="wallet" value="azotq.tg" />

    <label for="start">С:</label>
    <input
            type="datetime-local"
            id="start"
            step="1"
            value="2025-06-30T00:00:00"
    />

    <label for="end">По:</label>
    <input
            type="datetime-local"
            id="end"
            step="1"
            value="2025-07-01T23:59:59"
    />

    <button id="refresh">Обновить</button>
</div>

<div id="leaderboard">
    <div class="leaderboard-header">
        <div>№</div><div>Sender</div><div>Sum of Reputation</div>
    </div>
    <div id="items"></div>
</div>

<script>
    const API_PATH     = '/api/nft-reputation';
    const LIMIT        = 200;
    const MIN_INTERVAL = 5 * 60 * 1000; // 5 минут
    let lastFetchTime  = 0;

    document.getElementById('refresh').addEventListener('click', () => {
        lastFetchTime = 0;
        fetchAndRender();
    });
    window.addEventListener('DOMContentLoaded', fetchAndRender);

    async function fetchAndRender() {
        const now = Date.now();
        if (now - lastFetchTime < MIN_INTERVAL) return;
        lastFetchTime = now;

        const wallet = document.getElementById('wallet').value.trim();
        const start  = document.getElementById('start').value;
        const end    = document.getElementById('end').value;
        const out    = document.getElementById('items');
        out.innerHTML = '';

        if (!wallet) {
            out.innerHTML = `<div class="error">Укажите wallet_id.</div>`;
            return;
        }

        const ps = new URLSearchParams({ wallet_id: wallet, limit: LIMIT, skip: 0 });
        if (start) ps.set('start_time', new Date(start).toISOString());
        if (end)   ps.set('end_time',   new Date(end).toISOString());
        // для отладки добавляем debug=true, если нужно
        // ps.set('debug', 'true');

        try {
            const resp = await fetch(`${API_PATH}?${ps.toString()}`);
            if (!resp.ok) throw new Error(`API ${resp.status}`);
            const { leaderboard } = await resp.json();

            if (!leaderboard.length) {
                out.innerHTML = `<div class="error">Нет данных за указанный период.</div>`;
                return;
            }
            leaderboard.forEach((it, i) => {
                const row = document.createElement('div');
                row.className = 'leaderboard-item';
                row.innerHTML = `
            <div>${i+1}</div>
            <div>${it.wallet}</div>
            <div>${it.total.toLocaleString()}</div>
          `;
                out.appendChild(row);
            });
        } catch (e) {
            out.innerHTML = `<div class="error">Ошибка: ${e.message}</div>`;
            console.error(e);
        }
    }
</script>
</body>
</html>
